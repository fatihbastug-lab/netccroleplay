<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Call Role Play â€” Arama Tipine GÃ¶re Senaryo Motoru</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#666; --line:#e7e7ee;
      --blue:#2b6cff; --blue2:#eaf1ff; --gray:#f3f4f7; --chip:#f2f2f7;
      --good:#1d7a2c; --warn:#7a4b00; --bad:#b42318;
      --shadow: 0 8px 24px rgba(0,0,0,.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1220px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      padding:12px 14px; box-shadow:var(--shadow);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:10px;background:var(--blue2);display:grid;place-items:center;font-size:18px}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--chip)}
    .badge.ok{border-color:#cfe8d1;background:#f0fff1;color:var(--good)}
    .badge.warn{border-color:#f3d5a6;background:#fff7ea;color:var(--warn)}
    .badge.bad{border-color:#ffd0cc;background:#fff1f0;color:var(--bad)}
    .grid{display:grid;grid-template-columns:1.6fr 1fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card-h{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;align-items:center}
    .card-b{padding:12px 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{flex:1;min-width:220px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    select,input[type="range"],input[type="text"]{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .stage{
      font-weight:800;font-size:12px;padding:6px 10px;border-radius:999px;background:var(--blue2);color:#1343b6;border:1px solid #d9e6ff
    }
    .chat{height:480px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:10px}
    .bub{max-width:88%;padding:10px 12px;border-radius:14px;line-height:1.35;border:1px solid var(--line);white-space:pre-wrap}
    .cust{align-self:flex-start;background:var(--gray)}
    .agent{align-self:flex-end;background:var(--blue2);border-color:#d9e6ff}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;
      font-weight:700
    }
    button.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    button:disabled{opacity:.55;cursor:not-allowed}
    .pill{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi b{font-size:18px}
    .tip{background:var(--chip);border:1px dashed #d9d9e6}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .mini{font-size:12px;color:var(--muted)}
    .quick button{padding:9px 10px;font-weight:700}
    .lockline{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap}
    .lockdot{width:8px;height:8px;border-radius:999px;background:var(--bad);margin-top:6px}
    .lockdot.ok{background:var(--good)}
    .lockitem{flex:1;min-width:260px}

    /* Modal (Quiz) */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:18px
    }
    .modal{
      width:min(780px,100%);background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)
    }
    .modal-h{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .modal-b{padding:12px 14px}
    .q{padding:10px;border:1px solid var(--line);border-radius:14px;background:#fff;margin:10px 0}
    .q h4{margin:0 0 8px;font-size:14px}
    .opt{display:flex;gap:10px;align-items:flex-start;margin:6px 0}
    .opt input{margin-top:3px}
    .resultBox{border:1px solid var(--line);border-radius:14px;background:var(--gray);padding:10px}
    .copy{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">ğŸ§</div>
        <div>
          <h1>Call Role Play â€” Arama Tipine GÃ¶re Senaryo Motoru</h1>
          <div class="muted">Chrome/Edge Ã¶nerilir Â· Mikrofon izni gerekir Â· Tek sayfa demo</div>
        </div>
      </div>
      <div class="row">
        <div id="scenarioChip" class="badge">Senaryo: â€”</div>
        <div id="stageChip" class="stage">AÅŸama: 0/4</div>
        <div id="compat" class="badge warn">Kontrol ediliyorâ€¦</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="card-h">
          <div>
            <div style="font-weight:900">GÃ¶rÃ¼ÅŸme SimÃ¼lasyonu</div>
            <div class="muted" id="status">Durum: beklemede</div>
          </div>
          <div class="row">
            <button id="endBtn">âœ… GÃ¶rÃ¼ÅŸmeyi Bitir</button>
            <button id="resetBtn">â†º SÄ±fÄ±rla</button>
          </div>
        </div>

        <div class="card-b">
          <div class="row">
            <div class="field">
              <label>Arama Tipi</label>
              <select id="callType">
                <option value="sktt_sales" selected>SKTT SatÄ±ÅŸ (Ä°kili AnlaÅŸma)</option>
                <option value="sktt_info">SKTT Bilgilendirme</option>
                <option value="tariff_info">Kademeli/Ulusal Tarife Bilgi</option>
                <option value="iys_kvkk">Ä°YS/KVKK Ä°zin</option>
              </select>
            </div>

            <div class="field">
              <label>MÃ¼ÅŸteri Profili</label>
              <select id="persona">
                <option value="calm">Sakin</option>
                <option value="talkative" selected>KonuÅŸkan</option>
                <option value="angry">Ã–fkeli</option>
                <option value="bargainer">PazarlÄ±kÃ§Ä±</option>
              </select>
            </div>

            <div class="field">
              <label>KonuÅŸkanlÄ±k (1â€“10)</label>
              <input id="talk" type="range" min="1" max="10" value="8" />
              <div class="mini"><span id="talkVal">8</span>/10</div>
            </div>

            <div class="field">
              <label>Asistan AdÄ± (opsiyonel)</label>
              <input id="agentName" type="text" placeholder="Ã–rn: Fatih / 1234" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="pill tip">
            <div style="font-weight:900;margin-bottom:6px">Kilitler</div>
            <div class="lockline">
              <div class="lockitem">
                <div class="row" style="align-items:flex-start;gap:8px">
                  <span id="lockDotEmp" class="lockdot"></span>
                  <div>
                    <div style="font-weight:900">Empati</div>
                    <div class="mini" id="lockTextEmp">Empati algÄ±lanmadan sÃ¼reÃ§ ilerlemez.</div>
                  </div>
                </div>
              </div>

              <div class="lockitem">
                <div class="row" style="align-items:flex-start;gap:8px">
                  <span id="lockDotDocs" class="lockdot"></span>
                  <div>
                    <div style="font-weight:900">YazÄ±lÄ± Bilgilendirme/Teyit</div>
                    <div class="mini" id="lockTextDocs">Bu senaryoda SMS/Mail + teyit olmadan onaya geÃ§me.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row quick" id="quickRow"></div>
          <div class="mini">Not: Quick butonlar temsilci cÃ¼mlesi Ã¼retir. STT olmasa da akÄ±ÅŸÄ± test edersiniz.</div>

          <div class="divider"></div>

          <div class="chat" id="chat"></div>

          <div class="controls">
            <button class="primary" id="startBtn">â–¶ï¸ BaÅŸlat</button>
            <button id="talkBtn" disabled>ğŸ™ï¸ KonuÅŸmayÄ± BaÅŸlat</button>
            <button id="stopBtn" disabled>â¹ï¸ Durdur</button>
          </div>

          <div class="muted" style="margin-top:8px" id="flowHint">
            Hedef akÄ±ÅŸ: <b>Empati</b> â†’ <b>Bilgi</b> â†’ <b>Ã‡Ã¶zÃ¼m/Ä°ÅŸlem</b> â†’ <b>ProsedÃ¼r</b> â†’ <b>Onay/KapanÄ±ÅŸ</b>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="card-h">
          <div style="font-weight:900">ğŸ§  KoÃ§ & Puan</div>
        </div>
        <div class="card-b">
          <div id="coach" class="pill tip">BaÅŸlatâ€™a basÄ±nca mÃ¼ÅŸteri konuÅŸacak. Empati ile baÅŸla.</div>

          <div class="divider"></div>

          <div class="kpi">
            <div class="pill">Empati<br><b id="pEmp">0</b></div>
            <div class="pill">Bilgi/Ã‡erÃ§eve<br><b id="pInfo">0</b></div>
            <div class="pill">Ã‡Ã¶zÃ¼m/Teklif<br><b id="pSol">0</b></div>
            <div class="pill">ProsedÃ¼r<br><b id="pPro">0</b></div>
          </div>

          <div class="divider"></div>

          <div class="pill">
            <div style="font-weight:900;margin-bottom:6px">Mini Quiz</div>
            <div class="muted">â€œGÃ¶rÃ¼ÅŸmeyi Bitirâ€ ile aÃ§Ä±lÄ±r. 10 sorudan rastgele 3 soru seÃ§er.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QUIZ MODAL -->
  <div id="quizBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-h">
        <div style="font-weight:900">ğŸ“ Mini Quiz</div>
        <button id="closeQuiz">âœ•</button>
      </div>
      <div class="modal-b">
        <div class="muted">Quiz puanÄ± toplam skora eklenir (%70 Ã§aÄŸrÄ± + %30 quiz).</div>
        <div id="quizArea"></div>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="gradeQuiz" class="primary">âœ… Quizâ€™i DeÄŸerlendir</button>
        </div>

        <div class="divider"></div>

        <div id="finalArea" style="display:none">
          <div class="resultBox">
            <div style="font-weight:900;margin-bottom:6px">SonuÃ§</div>
            <div class="muted" id="finalSummary"></div>
            <div class="divider"></div>
            <div class="copy" id="reportText"></div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button id="copyReport">ğŸ“‹ Sonucu Kopyala</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  // --- Elements
  const chat = document.getElementById("chat");
  const statusEl = document.getElementById("status");
  const coachEl = document.getElementById("coach");
  const compatEl = document.getElementById("compat");
  const stageChip = document.getElementById("stageChip");
  const scenarioChip = document.getElementById("scenarioChip");
  const flowHint = document.getElementById("flowHint");

  const lockDotEmp = document.getElementById("lockDotEmp");
  const lockTextEmp = document.getElementById("lockTextEmp");
  const lockDotDocs = document.getElementById("lockDotDocs");
  const lockTextDocs = document.getElementById("lockTextDocs");

  const personaEl = document.getElementById("persona");
  const callTypeEl = document.getElementById("callType");
  const talkEl = document.getElementById("talk");
  const talkVal = document.getElementById("talkVal");
  const agentNameEl = document.getElementById("agentName");

  const startBtn = document.getElementById("startBtn");
  const talkBtn  = document.getElementById("talkBtn");
  const stopBtn  = document.getElementById("stopBtn");
  const endBtn   = document.getElementById("endBtn");
  const resetBtn = document.getElementById("resetBtn");

  const quizBackdrop = document.getElementById("quizBackdrop");
  const quizArea = document.getElementById("quizArea");
  const closeQuiz = document.getElementById("closeQuiz");
  const gradeQuiz = document.getElementById("gradeQuiz");
  const finalArea = document.getElementById("finalArea");
  const finalSummary = document.getElementById("finalSummary");
  const reportText = document.getElementById("reportText");
  const copyReport = document.getElementById("copyReport");

  const pEmp = document.getElementById("pEmp");
  const pInfo = document.getElementById("pInfo");
  const pSol = document.getElementById("pSol");
  const pPro = document.getElementById("pPro");

  const quickRow = document.getElementById("quickRow");

  talkEl.addEventListener("input", () => talkVal.textContent = talkEl.value);

  // --- Helpers
  function setCompat(ok, msg){
    compatEl.textContent = msg;
    compatEl.className = "badge " + (ok ? "ok" : "warn");
  }
  (function checkSupport(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const hasSR = !!SR;
    const hasTTS = !!window.speechSynthesis;
    if (hasSR && hasTTS) setCompat(true, "âœ… STT/TTS hazÄ±r");
    else if (!hasSR && hasTTS) setCompat(false, "âš ï¸ STT yok (Chrome/Edge)");
    else if (hasSR && !hasTTS) setCompat(false, "âš ï¸ TTS yok");
    else setCompat(false, "âš ï¸ STT/TTS yok");
  })();

  function addBubble(who, text){
    const div = document.createElement("div");
    div.className = "bub " + (who === "cust" ? "cust" : "agent");
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function speakTR(text){
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "tr-TR";
      window.speechSynthesis.speak(u);
    }catch{}
  }

  function rand(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

  // --- Score
  let score = { emp:0, info:0, sol:0, pro:0 };
  function renderScore(){
    pEmp.textContent = score.emp;
    pInfo.textContent = score.info;
    pSol.textContent = score.sol;
    pPro.textContent = score.pro;
  }
  function bump(key, val){
    score[key] = Math.min(100, score[key] + val);
    renderScore();
  }

  // --- Persona logic (talkativity)
  function talkativityLines(){
    const v = Number(talkEl.value);
    if (v <= 2) return 1;
    if (v <= 5) return 2;
    if (v <= 8) return 3;
    return 4;
  }
  function personaTone(){ return personaEl.value; }

  function buildReply(lines){
    const tone = personaTone();
    const n = talkativityLines();
    const extras = {
      calm: [
        "Bunu yazÄ±lÄ± olarak da gÃ¶rebilir miyim?",
        "Bir sonraki faturamÄ± nasÄ±l etkiler?"
      ],
      talkative: [
        "Bunun dayanaÄŸÄ± nedir, nasÄ±l hesaplanÄ±yor?",
        "Detay verir misiniz?",
        "AÅŸamalarÄ± sÄ±rayla gidelim lÃ¼tfen."
      ],
      angry: [
        "Ben bunu kabul etmiyorum.",
        "Net konuÅŸun, beni oyalamayÄ±n.",
        "Gerekirse ÅŸikayet kaydÄ± aÃ§acaÄŸÄ±m."
      ],
      bargainer: [
        "Daha iyi ÅŸart verirseniz onaylarÄ±m.",
        "Son yetkiniz nedir?",
        "Avantaj/indirim var mÄ±?"
      ]
    };

    let out = [];
    for (let i=0;i<Math.min(n, lines.length);i++) out.push(lines[i]);
    if (n >= 2) out.push(rand(extras[tone]));
    if (n >= 4) out.push(rand(extras[tone]));
    return out.slice(0,n).join(" ");
  }

  // --- Scenarios (Call Types)
  const SCENARIOS = {
    sktt_sales: {
      title: "SKTT SatÄ±ÅŸ (Ä°kili AnlaÅŸma)",
      stageLabels: ["Empati", "SKTT AÃ§Ä±klama", "Teklif (12 ay sabit)", "SMS/Mail + Teyit", "OTP + KapanÄ±ÅŸ"],
      gates: {
        empathy: { required: true, label: "Empati", cues: /(anlÄ±yorum|haklÄ±sÄ±nÄ±z|Ã¼zgÃ¼nÃ¼m|kusura|rahatsÄ±z edici|sizi anlÄ±yorum)/i },
        docsConfirm: { required: true, label: "YazÄ±lÄ± bilgilendirme teyidi", cues: /(ulaÅŸtÄ±|geldi|okudum|bilgilendirildim|teyit|onaylÄ±yorum)/i }
      },
      cues: {
        info: /(son kaynak|sktt|son kaynak tedarik tarifesi|serbest tÃ¼ketici|limit|yÃ¼ksek tÃ¼ketim|dinamik|piyasa|ptf|yekdem|kbk)/i,
        sol: /(ikili|anlaÅŸ|12 ay|sabit|aktif enerji|birim bedel|Ã¶ngÃ¶rÃ¼|kampanya|fiyat)/i,
        pro: /(ek-?1|ek-?2|kvkk|sms|mail|e-?posta|bilgilendirme|fiyat karÅŸÄ±laÅŸtÄ±rma|teyit|otp|doÄŸrulama kodu|6 haneli)/i
      },
      wrong: [
        { re: /(sktt).*?(taahhÃ¼t|cayma|ceza)/i, msg: "KoÃ§: SKTTâ€™yi taahhÃ¼t/ceza gibi anlatma. SKTT = Son Kaynak Tedarik Tarifesi (piyasa bazlÄ±/dinamik maliyet)." },
        { re: /(hemen|bugÃ¼n).*?(baÅŸlar|aktif olur)/i, msg: "KoÃ§: BaÅŸlangÄ±Ã§ tarihi sÃ¼reÃ§/aktivasyonla ilerler; 'hemen baÅŸlar' gibi kesin vaat verme." }
      ],
      quick: [
        { key:"emp", label:"ğŸ’¬ Empati", text:"Sizi anlÄ±yorum; bu durum rahatsÄ±z edici olabilir. Birlikte netleÅŸtirip Ã§Ã¶zÃ¼m sunacaÄŸÄ±m." },
        { key:"sktt", label:"ğŸ“Œ SKTT AÃ§Ä±kla", text:"SKTT, Son Kaynak Tedarik Tarifesi kapsamÄ±dÄ±r. Serbest tÃ¼ketici olup belirli tÃ¼ketim limitleri aÅŸÄ±ldÄ±ÄŸÄ±nda ve ikili anlaÅŸma yoksa aktif enerji maliyeti piyasa koÅŸullarÄ±na gÃ¶re daha deÄŸiÅŸken yansÄ±yabilir." },
        { key:"offer", label:"ğŸ¯ Teklif", text:"Ã‡Ã¶zÃ¼m olarak ikili anlaÅŸma sunabilirim: 12 ay boyunca aktif enerji birim bedelinizi sabitleyerek fiyat Ã¶ngÃ¶rÃ¼lebilirliÄŸi saÄŸlar." },
        { key:"docs", label:"ğŸ“© SMS/Mail", text:"ÅartlarÄ± SMS ve e-posta ile ileteceÄŸim (KVKK + Ek-1/Ek-2 bilgilendirme). Size ulaÅŸtÄ±ÄŸÄ±nda bilgilendirildiÄŸinizi teyit eder misiniz?" },
        { key:"otp", label:"ğŸ” OTP", text:"Onay iÃ§in 6 haneli doÄŸrulama kodu (OTP) gÃ¶ndereceÄŸim. Kodu paylaÅŸtÄ±ÄŸÄ±nÄ±zda iÅŸlemi tamamlayacaÄŸÄ±m." },
        { key:"close", label:"âœ… KapanÄ±ÅŸ", text:"Ã–zetle; SKTT kapsamÄ±nÄ± aÃ§Ä±kladÄ±m, 12 ay sabit aktif enerji teklifini sundum ve yazÄ±lÄ± bilgilendirmeyi ilettim. Onay adÄ±mÄ±ndan sonra iÅŸlemi sonuÃ§landÄ±rÄ±yorum. BaÅŸka yardÄ±mcÄ± olabileceÄŸim konu var mÄ±?" }
      ],
      opens: {
        calm: ["Merhaba. SKTTâ€™ye geÃ§tiÄŸimi gÃ¶rdÃ¼m. Neden oldu ve Ã§Ã¶zÃ¼mÃ¼nÃ¼z var mÄ±?"],
        talkative: ["Merhaba. SKTTâ€™ye geÃ§miÅŸim. Bu tam olarak nedir, neden oldum ve ikili anlaÅŸma ile nasÄ±l Ã§Ä±kabilirim?"],
        angry: ["Merhaba! SKTTâ€™ye almÄ±ÅŸsÄ±nÄ±z, faturam uÃ§tu. Hemen aÃ§Ä±klayÄ±n ve Ã§Ã¶zÃ¼n!"],
        bargainer: ["Merhaba. SKTT kapsamÄ±ndayÄ±m. EÄŸer iyi bir ikili anlaÅŸma teklifi varsa deÄŸerlendirebilirim."]
      },
      coachByStage: [
        "KoÃ§: Empati kilidini aÃ§. (KÄ±sa ama net empati cÃ¼mlesi.)",
        "KoÃ§: SKTTâ€™yi net tanÄ±mla: Son Kaynak Tedarik Tarifesi, limit/serbest tÃ¼ketici, deÄŸiÅŸken maliyet Ã§erÃ§evesi.",
        "KoÃ§: Ã‡Ã¶zÃ¼m: 12 ay sabit aktif enerji birim bedeli (Ã¶ngÃ¶rÃ¼ + stabilite).",
        "KoÃ§: ProsedÃ¼r: SMS/Mail bilgilendirme (KVKK + Ekler) + â€˜bilgilendirildimâ€™ teyidi al.",
        "KoÃ§: OTP/Onay + kapanÄ±ÅŸ: Ã¶zetle, teÅŸekkÃ¼r et, ek ihtiyaÃ§ sor."
      ],
      quizPool: [
        { id:"q1", q:"SKTT (elektrik) en doÄŸru ÅŸekilde neyi ifade eder?", options:[
          {k:"A", t:"TaahhÃ¼t cayma bedelidir", ok:false},
          {k:"B", t:"Son Kaynak Tedarik Tarifesi kapsamÄ±dÄ±r", ok:true},
          {k:"C", t:"DaÄŸÄ±tÄ±m bedelidir", ok:false},
          {k:"D", t:"Vergi kalemidir", ok:false}
        ]},
        { id:"q2", q:"SKTTâ€™de maliyetin deÄŸiÅŸken olabilmesinin temel nedeni nedir?", options:[
          {k:"A", t:"Aktif enerji maliyetinin piyasa koÅŸullarÄ±na gÃ¶re deÄŸiÅŸebilmesi", ok:true},
          {k:"B", t:"DaÄŸÄ±tÄ±m bedelinin her gÃ¼n deÄŸiÅŸmesi", ok:false},
          {k:"C", t:"KDVâ€™nin aylÄ±k deÄŸiÅŸmesi", ok:false},
          {k:"D", t:"SayaÃ§larÄ±n otomatik zam yapmasÄ±", ok:false}
        ]},
        { id:"q3", q:"Ä°kili anlaÅŸmanÄ±n mÃ¼ÅŸteriye temel faydasÄ± nedir?", options:[
          {k:"A", t:"Aktif enerji birim bedelini sÃ¼re boyunca sabitleyerek Ã¶ngÃ¶rÃ¼ saÄŸlar", ok:true},
          {k:"B", t:"TÃ¼m vergileri kaldÄ±rÄ±r", ok:false},
          {k:"C", t:"DaÄŸÄ±tÄ±m bedelini sÄ±fÄ±rlar", ok:false},
          {k:"D", t:"TÃ¼ketimi otomatik dÃ¼ÅŸÃ¼rÃ¼r", ok:false}
        ]},
        { id:"q4", q:"ProsedÃ¼r aÃ§Ä±sÄ±ndan doÄŸru adÄ±m hangisidir?", options:[
          {k:"A", t:"Bilgilendirme gÃ¶ndermeden onay almak", ok:false},
          {k:"B", t:"SMS/mail bilgilendirme + teyit sonrasÄ± onay istemek", ok:true},
          {k:"C", t:"Ä°tiraz olunca gÃ¶rÃ¼ÅŸmeyi kapatmak", ok:false},
          {k:"D", t:"YanlÄ±ÅŸ bilgiyle ikna etmek", ok:false}
        ]},
        { id:"q5", q:"MÃ¼ÅŸteri tepkili olduÄŸunda ilk yapÄ±lmasÄ± gereken nedir?", options:[
          {k:"A", t:"Empati kurup netleÅŸtirmek", ok:true},
          {k:"B", t:"Hemen fiyat sÃ¶ylemek", ok:false},
          {k:"C", t:"Konuyu deÄŸiÅŸtirmek", ok:false},
          {k:"D", t:"Sessiz kalmak", ok:false}
        ]},
        { id:"q6", q:"MÃ¼ÅŸteri â€œSMS gelmediâ€ derse doÄŸru aksiyon nedir?", options:[
          {k:"A", t:"Tekrar gÃ¶nderip teyit almak", ok:true},
          {k:"B", t:"Onay isteyip devam etmek", ok:false},
          {k:"C", t:"GÃ¶rÃ¼ÅŸmeyi kapatmak", ok:false},
          {k:"D", t:"Ä°tirazÄ± yok saymak", ok:false}
        ]},
        { id:"q7", q:"YanlÄ±ÅŸ bilgi Ã¶rneÄŸi hangisidir?", options:[
          {k:"A", t:"SKTT = Son Kaynak Tedarik Tarifesi", ok:false},
          {k:"B", t:"SKTT = taahhÃ¼t cayma bedeli", ok:true},
          {k:"C", t:"Ä°kili anlaÅŸma sabit fiyat iÃ§erebilir", ok:false},
          {k:"D", t:"Bilgilendirme sonrasÄ± onay alÄ±nÄ±r", ok:false}
        ]},
        { id:"q8", q:"KapanÄ±ÅŸta en doÄŸru davranÄ±ÅŸ nedir?", options:[
          {k:"A", t:"Ã–zet + teÅŸekkÃ¼r + ek ihtiyaÃ§ sorusu", ok:true},
          {k:"B", t:"Bir anda kapatmak", ok:false},
          {k:"C", t:"Yeni konu aÃ§mak", ok:false},
          {k:"D", t:"MÃ¼ÅŸteriyi suÃ§lamak", ok:false}
        ]},
        { id:"q9", q:"Onay (OTP) adÄ±mÄ± iÃ§in en doÄŸru yaklaÅŸÄ±m hangisidir?", options:[
          {k:"A", t:"Kodu alÄ±p iÅŸlemi tamamlamadan Ã¶nce bilgilendirme teyidini almak", ok:true},
          {k:"B", t:"Bilgilendirme olmadan kod istemek", ok:false},
          {k:"C", t:"Kodu hiÃ§ istemeden onaylamak", ok:false},
          {k:"D", t:"Kodu mÃ¼ÅŸteriye sÃ¶ylemek", ok:false}
        ]},
        { id:"q10", q:"SKTTâ€™den Ã§Ä±kÄ±ÅŸ iÃ§in en net Ã§Ã¶zÃ¼m hangisidir?", options:[
          {k:"A", t:"Ä°kili anlaÅŸma/tedarikÃ§i sÃ¶zleÅŸmesi ile tedariki yapÄ±landÄ±rmak", ok:true},
          {k:"B", t:"HiÃ§bir ÅŸey yapmadan otomatik Ã§Ä±kmak", ok:false},
          {k:"C", t:"Vergi dilekÃ§esi vermek", ok:false},
          {k:"D", t:"DaÄŸÄ±tÄ±m ÅŸirketini deÄŸiÅŸtirmek", ok:false}
        ]}
      ]
    },

    sktt_info: {
      title: "SKTT Bilgilendirme",
      stageLabels: ["Empati", "SKTT TanÄ±mÄ±", "Hesap MantÄ±ÄŸÄ±", "YÃ¶nlendirme/KapanÄ±ÅŸ", "KapanÄ±ÅŸ"],
      gates: {
        empathy: { required: true, label: "Empati", cues: /(anlÄ±yorum|haklÄ±sÄ±nÄ±z|Ã¼zgÃ¼nÃ¼m|kusura|rahatsÄ±z edici|sizi anlÄ±yorum)/i },
        docsConfirm: { required: false, label: "YazÄ±lÄ± teyit", cues: /.^/ } // devre dÄ±ÅŸÄ±
      },
      cues: {
        info: /(sktt|son kaynak|serbest tÃ¼ketici|limit|yÃ¼ksek tÃ¼ketim|dinamik|ptf|yekdem|kbk)/i,
        sol: /(nasÄ±l hesap|ptf|yekdem|kbk|piyasa|fatura)/i,
        pro: /(daÄŸÄ±tÄ±m ÅŸirketi|nihai tÃ¼ketim|fatura Ã¼zerinden|kayÄ±t|ÅŸikayet)/i
      },
      wrong: [
        { re: /(sktt).*?(taahhÃ¼t|cayma|ceza)/i, msg: "KoÃ§: SKTTâ€™yi taahhÃ¼t/ceza gibi anlatma. SKTT = Son Kaynak Tedarik Tarifesi." }
      ],
      quick: [
        { key:"emp", label:"ğŸ’¬ Empati", text:"Sizi anlÄ±yorum. Bu durum kafa karÄ±ÅŸtÄ±rÄ±cÄ± olabilir; birlikte netleÅŸtirelim." },
        { key:"sktt", label:"ğŸ“Œ SKTT TanÄ±mÄ±", text:"SKTT, Son Kaynak Tedarik Tarifesi kapsamÄ±dÄ±r. Serbest tÃ¼ketici olup belirli tÃ¼ketim limitleri aÅŸÄ±ldÄ±ÄŸÄ±nda ikili anlaÅŸma yoksa aktif enerji maliyeti daha deÄŸiÅŸken yansÄ±yabilir." },
        { key:"calc", label:"ğŸ§¾ Hesap MantÄ±ÄŸÄ±", text:"SKTTâ€™de aktif enerji maliyeti dÃ¶nemsel piyasa maliyetlerine gÃ¶re deÄŸiÅŸebilir (Ã¶rnek: PTF/YEKDEM gibi bileÅŸenler). Bu yÃ¼zden aylara gÃ¶re dalgalanma gÃ¶rÃ¼lebilir." },
        { key:"route", label:"ğŸ“ YÃ¶nlendirme", text:"TÃ¼ketiminizin nihai bilgisi ve sayaÃ§ okuma detaylarÄ± iÃ§in daÄŸÄ±tÄ±m ÅŸirketi ve fatura kalemleri Ã¼zerinden takip edebilirsiniz; ben de bilgilendirme kaydÄ± aÃ§abilirim." },
        { key:"close", label:"âœ… KapanÄ±ÅŸ", text:"Ã–zetle SKTT kapsamÄ±nÄ± ve maliyetin neden deÄŸiÅŸebildiÄŸini anlattÄ±m. BaÅŸka sormak istediÄŸiniz bir ÅŸey var mÄ±?" }
      ],
      opens: {
        calm: ["Merhaba. SKTTâ€™ye geÃ§tiÄŸimi gÃ¶rdÃ¼m. Nedir bu?"],
        talkative: ["Merhaba. SKTT ne demek? Neden ben SKTTâ€™ye geÃ§tim?"],
        angry: ["Merhaba! SKTTâ€™ye aldÄ±nÄ±z, faturam arttÄ±. Bu ne?"],
        bargainer: ["Merhaba. SKTT kapsamÄ±ndayÄ±m. Ã–nce bir net aÃ§Ä±klama alayÄ±m."]
      },
      coachByStage: [
        "KoÃ§: Empati ile baÅŸla.",
        "KoÃ§: SKTTâ€™yi net tanÄ±mla.",
        "KoÃ§: DeÄŸiÅŸken maliyet/hesap mantÄ±ÄŸÄ±nÄ± basit anlat.",
        "KoÃ§: Gerekirse daÄŸÄ±tÄ±m/nihai tÃ¼ketim Ã§erÃ§evesi + kapanÄ±ÅŸ.",
        "KoÃ§: KapanÄ±ÅŸ (Ã¶zet + teÅŸekkÃ¼r)."
      ],
      quizPool: [
        { id:"q1", q:"SKTT neyi ifade eder?", options:[
          {k:"A", t:"Son Kaynak Tedarik Tarifesi", ok:true},
          {k:"B", t:"Sabit Kampanya Tarifesi", ok:false},
          {k:"C", t:"SayaÃ§ Kesme Tahakkuk Tarifesi", ok:false},
          {k:"D", t:"KDV tÃ¼rÃ¼", ok:false}
        ]},
        { id:"q2", q:"SKTTâ€™de maliyet neden dalgalanabilir?", options:[
          {k:"A", t:"Piyasa/tedarik maliyetleri deÄŸiÅŸebildiÄŸi iÃ§in", ok:true},
          {k:"B", t:"KDV her gÃ¼n deÄŸiÅŸtiÄŸi iÃ§in", ok:false},
          {k:"C", t:"DaÄŸÄ±tÄ±m bedeli gÃ¼nlÃ¼k deÄŸiÅŸtiÄŸi iÃ§in", ok:false},
          {k:"D", t:"SayaÃ§ tÃ¼rÃ¼ yÃ¼zÃ¼nden", ok:false}
        ]},
        // 8 tane daha kÄ±sa soru (basit)
        { id:"q3", q:"SKTT yanlÄ±ÅŸ anlatÄ±m Ã¶rneÄŸi hangisi?", options:[
          {k:"A", t:"SKTT = taahhÃ¼t cayma bedeli", ok:true},
          {k:"B", t:"SKTT = Son Kaynak Tedarik Tarifesi", ok:false},
          {k:"C", t:"SKTTâ€™de maliyet deÄŸiÅŸebilir", ok:false},
          {k:"D", t:"Bilgilendirme yapÄ±lÄ±r", ok:false}
        ]},
        { id:"q4", q:"MÃ¼ÅŸteri tepkiliyse ilk adÄ±m?", options:[
          {k:"A", t:"Empati kurmak", ok:true},
          {k:"B", t:"Konuyu kapatmak", ok:false},
          {k:"C", t:"Konuyu deÄŸiÅŸtirmek", ok:false},
          {k:"D", t:"Sessiz kalmak", ok:false}
        ]},
        { id:"q5", q:"SKTTâ€™de â€˜deÄŸiÅŸkenâ€™ neyi anlatÄ±r?", options:[
          {k:"A", t:"Aktif enerji maliyetinin dÃ¶nemsel deÄŸiÅŸebilmesini", ok:true},
          {k:"B", t:"DaÄŸÄ±tÄ±m bedelinin sÄ±fÄ±r olmasÄ±nÄ±", ok:false},
          {k:"C", t:"Vergilerin kalkmasÄ±nÄ±", ok:false},
          {k:"D", t:"SÃ¶zleÅŸmenin otomatik yenilenmesini", ok:false}
        ]},
        { id:"q6", q:"KapanÄ±ÅŸta doÄŸru davranÄ±ÅŸ?", options:[
          {k:"A", t:"Ã–zet + teÅŸekkÃ¼r", ok:true},
          {k:"B", t:"Bir anda kapat", ok:false},
          {k:"C", t:"MÃ¼ÅŸteriyi suÃ§la", ok:false},
          {k:"D", t:"Yeni konu aÃ§", ok:false}
        ]},
        { id:"q7", q:"SKTT tanÄ±mÄ± hangi kalemle ilgilidir?", options:[
          {k:"A", t:"Tedarik/Aktif enerji", ok:true},
          {k:"B", t:"Sadece daÄŸÄ±tÄ±m", ok:false},
          {k:"C", t:"Sadece vergi", ok:false},
          {k:"D", t:"Sadece sayaÃ§", ok:false}
        ]},
        { id:"q8", q:"MÃ¼ÅŸteri tÃ¼ketimini nereden takip eder?", options:[
          {k:"A", t:"Fatura/okuma bilgileri Ã¼zerinden", ok:true},
          {k:"B", t:"Sadece SMS ile", ok:false},
          {k:"C", t:"Sadece Ã§aÄŸrÄ± merkezi", ok:false},
          {k:"D", t:"Takip edemez", ok:false}
        ]},
        { id:"q9", q:"Bilgilendirme amacÄ± nedir?", options:[
          {k:"A", t:"MÃ¼ÅŸterinin konuyu net anlamasÄ±", ok:true},
          {k:"B", t:"MÃ¼ÅŸteriyi susturmak", ok:false},
          {k:"C", t:"FaturayÄ± iptal etmek", ok:false},
          {k:"D", t:"Vergi kaldÄ±rmak", ok:false}
        ]},
        { id:"q10", q:"Empati cÃ¼mlesi Ã¶rneÄŸi hangisi?", options:[
          {k:"A", t:"Sizi anlÄ±yorum, birlikte netleÅŸtirelim.", ok:true},
          {k:"B", t:"Beni ilgilendirmez.", ok:false},
          {k:"C", t:"KapatÄ±yorum.", ok:false},
          {k:"D", t:"Siz yanlÄ±ÅŸ yapmÄ±ÅŸsÄ±nÄ±z.", ok:false}
        ]}
      ]
    },

    tariff_info: {
      title: "Kademeli/Ulusal Tarife Bilgi",
      stageLabels: ["Empati", "Tarife TanÄ±mÄ±", "Kademe MantÄ±ÄŸÄ±", "Ã–zet/KapanÄ±ÅŸ", "KapanÄ±ÅŸ"],
      gates: {
        empathy: { required: true, label: "Empati", cues: /(anlÄ±yorum|haklÄ±sÄ±nÄ±z|Ã¼zgÃ¼nÃ¼m|kusura|sizi anlÄ±yorum)/i },
        docsConfirm: { required: false, label: "YazÄ±lÄ± teyit", cues: /.^/ }
      },
      cues: {
        info: /(ulusal|tarife|kademeli|dÃ¼ÅŸÃ¼k kademe|yÃ¼ksek kademe|epdk)/i,
        sol: /(8\s*kwh|30\s*kwh|gÃ¼nlÃ¼k|ortalama|kademe|limit)/i,
        pro: /(fatura|kalem|kwh|okuma)/i
      },
      wrong: [
        { re: /(3\s*zamanlÄ±).*?(kademe uygulanÄ±r)/i, msg: "KoÃ§: 3 zamanlÄ± tarifede kademe uygulanmaz gibi kesin konuÅŸma; net Ã§erÃ§eve ver ve kalemleri aÃ§Ä±klamaya odaklan." }
      ],
      quick: [
        { key:"emp", label:"ğŸ’¬ Empati", text:"AnlÄ±yorum; tarife yapÄ±larÄ± kafa karÄ±ÅŸtÄ±rabiliyor. BasitÃ§e aÃ§Ä±klayayÄ±m." },
        { key:"def", label:"ğŸ“Œ TanÄ±m", text:"Ulusal tarife EPDK tarafÄ±ndan dÃ¶nemsel belirlenen bir Ã§erÃ§evedir. Kademeli tarife ise tÃ¼ketim belirli sÄ±nÄ±rlarÄ± aÅŸÄ±nca birim bedelin kademeye gÃ¶re deÄŸiÅŸmesidir." },
        { key:"kwh", label:"âš¡ Kademe", text:"Kademe mantÄ±ÄŸÄ± gÃ¼nlÃ¼k ortalama tÃ¼ketim Ã¼zerinden hesaplanabilir. Ã–rnek: meskende gÃ¼nlÃ¼k 8 kWh eÅŸik gibi yaklaÅŸÄ±m kullanÄ±lÄ±r." },
        { key:"bill", label:"ğŸ§¾ Fatura", text:"Faturada tÃ¼ketim (kWh) ve birim bedel/kademe ayrÄ±mÄ± gÃ¶rÃ¼lÃ¼r. Ä°sterseniz kalem kalem Ã¼zerinden gidelim." },
        { key:"close", label:"âœ… KapanÄ±ÅŸ", text:"Ã–zetle ulusal/kademeli tarife mantÄ±ÄŸÄ±nÄ± anlattÄ±m. BaÅŸka sormak istediÄŸiniz bir ÅŸey var mÄ±?" }
      ],
      opens: {
        calm: ["Merhaba, kademeli tarife ne demek?"],
        talkative: ["Merhaba, kademeli tarife nasÄ±l hesaplanÄ±yor, neden yÃ¼ksek kademeye geÃ§tim?"],
        angry: ["Merhaba! Kademeye girdim diye faturam arttÄ±. Nedir bu?"],
        bargainer: ["Merhaba, tarifemi daha avantajlÄ± hale getirebilir miyiz?"]
      },
      coachByStage: [
        "KoÃ§: Empati.",
        "KoÃ§: Ulusal/kademeli tarife tanÄ±mÄ±.",
        "KoÃ§: Kademe mantÄ±ÄŸÄ±: tÃ¼ketim eÅŸikleri + Ã¶rnek anlatÄ±m.",
        "KoÃ§: Ã–zet + gerekirse faturadan kalem kalem yÃ¶nlendirme.",
        "KoÃ§: KapanÄ±ÅŸ."
      ],
      quizPool: [
        { id:"q1", q:"Kademeli tarife neyi ifade eder?", options:[
          {k:"A", t:"TÃ¼ketim eÅŸiÄŸine gÃ¶re birim bedelin deÄŸiÅŸmesi", ok:true},
          {k:"B", t:"Vergilerin kaldÄ±rÄ±lmasÄ±", ok:false},
          {k:"C", t:"DaÄŸÄ±tÄ±m bedelinin iptali", ok:false},
          {k:"D", t:"SayaÃ§ tÃ¼rÃ¼", ok:false}
        ]},
        // (toplam 10)
        { id:"q2", q:"Ulusal tarife Ã§erÃ§evesi kim tarafÄ±ndan belirlenir?", options:[
          {k:"A", t:"EPDK gibi dÃ¼zenleyici otorite", ok:true},
          {k:"B", t:"Sadece mÃ¼ÅŸteri", ok:false},
          {k:"C", t:"Sadece daÄŸÄ±tÄ±m ÅŸirketi", ok:false},
          {k:"D", t:"Banka", ok:false}
        ]},
        { id:"q3", q:"MÃ¼ÅŸteri tepkiliyse ilk adÄ±m?", options:[
          {k:"A", t:"Empati kurmak", ok:true},
          {k:"B", t:"Kapatmak", ok:false},
          {k:"C", t:"Azarlamak", ok:false},
          {k:"D", t:"Konuyu deÄŸiÅŸtirmek", ok:false}
        ]},
        { id:"q4", q:"Kademe hesabÄ± hangi veriye dayanÄ±r?", options:[
          {k:"A", t:"TÃ¼ketim (kWh)", ok:true},
          {k:"B", t:"Telefon modeli", ok:false},
          {k:"C", t:"E-posta", ok:false},
          {k:"D", t:"Adres kodu", ok:false}
        ]},
        { id:"q5", q:"Faturada kademe etkisi nerede gÃ¶rÃ¼lÃ¼r?", options:[
          {k:"A", t:"Birim bedel/tutar kalemlerinde", ok:true},
          {k:"B", t:"Sadece sayaÃ§ seri numarasÄ±nda", ok:false},
          {k:"C", t:"Bankada", ok:false},
          {k:"D", t:"HiÃ§bir yerde", ok:false}
        ]},
        { id:"q6", q:"DoÄŸru kapanÄ±ÅŸ hangisi?", options:[
          {k:"A", t:"Ã–zet + teÅŸekkÃ¼r + ek soru", ok:true},
          {k:"B", t:"Bir anda kapat", ok:false},
          {k:"C", t:"MÃ¼ÅŸteriyi suÃ§la", ok:false},
          {k:"D", t:"Yeni konu aÃ§", ok:false}
        ]},
        { id:"q7", q:"Kademeli tarifede amaÃ§ nedir?", options:[
          {k:"A", t:"TÃ¼ketimi eÅŸiklere gÃ¶re farklÄ± fiyatlandÄ±rmak", ok:true},
          {k:"B", t:"Vergi kaldÄ±rmak", ok:false},
          {k:"C", t:"DaÄŸÄ±tÄ±mÄ± kapatmak", ok:false},
          {k:"D", t:"SayaÃ§ deÄŸiÅŸtirmek", ok:false}
        ]},
        { id:"q8", q:"Temsilci ne yapmalÄ±?", options:[
          {k:"A", t:"BasitÃ§e Ã§erÃ§eve verip kalemleri aÃ§Ä±klamalÄ±", ok:true},
          {k:"B", t:"Konuyu gizlemeli", ok:false},
          {k:"C", t:"SertleÅŸmeli", ok:false},
          {k:"D", t:"YanlÄ±ÅŸ bilgi vermeli", ok:false}
        ]},
        { id:"q9", q:"Tarife bilgisi verirken nelere dikkat edilir?", options:[
          {k:"A", t:"Net tanÄ±m + Ã¶rnek + fatura kalemleri", ok:true},
          {k:"B", t:"Uzun uzun konu dÄ±ÅŸÄ±", ok:false},
          {k:"C", t:"Sadece fiyat sÃ¶ylemek", ok:false},
          {k:"D", t:"Sessiz kalmak", ok:false}
        ]},
        { id:"q10", q:"Empati cÃ¼mlesi Ã¶rneÄŸi?", options:[
          {k:"A", t:"AnlÄ±yorum, birlikte netleÅŸtirelim.", ok:true},
          {k:"B", t:"Beni ilgilendirmez.", ok:false},
          {k:"C", t:"KapatÄ±yorum.", ok:false},
          {k:"D", t:"Siz hata yapmÄ±ÅŸsÄ±nÄ±z.", ok:false}
        ]}
      ]
    },

    iys_kvkk: {
      title: "Ä°YS/KVKK Ä°zin",
      stageLabels: ["Empati", "Ä°YS/KVKK AÃ§Ä±klama", "Ä°zin SeÃ§enekleri", "Onay/Ret + KapanÄ±ÅŸ", "KapanÄ±ÅŸ"],
      gates: {
        empathy: { required: true, label: "Empati", cues: /(anlÄ±yorum|haklÄ±sÄ±nÄ±z|Ã¼zgÃ¼nÃ¼m|kusura|sizi anlÄ±yorum)/i },
        docsConfirm: { required: true, label: "AÃ§Ä±k rÄ±za/izin", cues: /(kabul|onaylÄ±yorum|izin veriyorum|aÃ§Ä±k rÄ±za)/i }
      },
      cues: {
        info: /(iys|ileti yÃ¶netim|ticari elektronik ileti|kvkk|aÃ§Ä±k rÄ±za|veri iÅŸleme)/i,
        sol: /(sms|mail|arama|kanal|izin|ret)/i,
        pro: /(onay|kabul|ret|iptal|teyit)/i
      },
      wrong: [
        { re: /(izin).*?(gereksiz|Ã¶nemsiz|boÅŸver)/i, msg: "KoÃ§: Ä°YS/KVKKâ€™yÄ± kÃ¼Ã§Ã¼mseme. Åeffaf ve net bilgilendir." }
      ],
      quick: [
        { key:"emp", label:"ğŸ’¬ Empati", text:"AnlÄ±yorum; izin ve KVKK metinleri karmaÅŸÄ±k gelebilir. KÄ±sa ve net anlatayÄ±m." },
        { key:"info", label:"ğŸ“Œ Ä°YS/KVKK", text:"Ä°YS, ticari elektronik ileti izinlerinin yÃ¶netildiÄŸi sistemdir. KVKK kapsamÄ±nda verilerin iÅŸlenmesi iÃ§in aÃ§Ä±k rÄ±za ve bilgilendirme yapÄ±lÄ±r." },
        { key:"opts", label:"ğŸ“² Kanallar", text:"Ä°sterseniz SMS, e-posta ve arama kanallarÄ±nÄ± ayrÄ± ayrÄ± tercih edebilirsiniz. Ä°stediÄŸiniz zaman ret/iptal hakkÄ±nÄ±z da vardÄ±r." },
        { key:"consent", label:"âœ… AÃ§Ä±k RÄ±za", text:"Devam edebilmem iÃ§in â€˜verilerimin iÅŸlenmesine ve ileti iznineâ€™ onay verdiÄŸinizi teyit eder misiniz?" },
        { key:"close", label:"âœ… KapanÄ±ÅŸ", text:"Ã–zetle Ä°YS/KVKK Ã§erÃ§evesini ve izin seÃ§eneklerini paylaÅŸtÄ±m. BaÅŸka yardÄ±mcÄ± olabileceÄŸim konu var mÄ±?" }
      ],
      opens: {
        calm: ["Merhaba. Neden ileti izni soruyorsunuz?"],
        talkative: ["Merhaba. Ä°YS nedir, KVKK aÃ§Ä±sÄ±ndan benden ne onayÄ± alÄ±yorsunuz?"],
        angry: ["Merhaba! SÃ¼rekli izin diyorsunuz, neden?"],
        bargainer: ["Merhaba. Ä°zin versem bana ne avantaj var?"]
      },
      coachByStage: [
        "KoÃ§: Empati.",
        "KoÃ§: Ä°YS ve KVKKâ€™yÄ± ÅŸeffaf biÃ§imde aÃ§Ä±kla.",
        "KoÃ§: Kanal bazlÄ± izin seÃ§eneklerini sun.",
        "KoÃ§: Onay/ret durumunu yÃ¶net + kapanÄ±ÅŸ.",
        "KoÃ§: KapanÄ±ÅŸ."
      ],
      quizPool: [
        { id:"q1", q:"Ä°YS neyle ilgilidir?", options:[
          {k:"A", t:"Ticari elektronik ileti izinlerinin yÃ¶netimi", ok:true},
          {k:"B", t:"Elektrik sayacÄ±", ok:false},
          {k:"C", t:"DaÄŸÄ±tÄ±m bedeli", ok:false},
          {k:"D", t:"Vergi tÃ¼rÃ¼", ok:false}
        ]},
        { id:"q2", q:"KVKK kapsamÄ±nda ne Ã¶nemlidir?", options:[
          {k:"A", t:"Bilgilendirme ve aÃ§Ä±k rÄ±za", ok:true},
          {k:"B", t:"MÃ¼ÅŸteriyi zorlamak", ok:false},
          {k:"C", t:"Gizlemek", ok:false},
          {k:"D", t:"Ä°zin almamak", ok:false}
        ]},
        { id:"q3", q:"Ä°zinler nasÄ±l verilebilir?", options:[
          {k:"A", t:"Kanal bazlÄ± (SMS/mail/arama) tercih edilebilir", ok:true},
          {k:"B", t:"Sadece SMS", ok:false},
          {k:"C", t:"Sadece arama", ok:false},
          {k:"D", t:"HiÃ§ verilemez", ok:false}
        ]},
        { id:"q4", q:"MÃ¼ÅŸteri ret ederse ne yapÄ±lÄ±r?", options:[
          {k:"A", t:"KararÄ± saygÄ±yla alÄ±p sÃ¼reci kapatmak", ok:true},
          {k:"B", t:"Zorlamak", ok:false},
          {k:"C", t:"Azarlamak", ok:false},
          {k:"D", t:"YanlÄ±ÅŸ bilgi vermek", ok:false}
        ]},
        { id:"q5", q:"Empati cÃ¼mlesi Ã¶rneÄŸi?", options:[
          {k:"A", t:"AnlÄ±yorum, netleÅŸtirelim.", ok:true},
          {k:"B", t:"Beni ilgilendirmez.", ok:false},
          {k:"C", t:"KapatÄ±yorum.", ok:false},
          {k:"D", t:"Siz anlamÄ±yorsunuz.", ok:false}
        ]},
        { id:"q6", q:"DoÄŸru kapanÄ±ÅŸ hangisi?", options:[
          {k:"A", t:"Ã–zet + teÅŸekkÃ¼r + ek ihtiyaÃ§ sorusu", ok:true},
          {k:"B", t:"Bir anda kapatmak", ok:false},
          {k:"C", t:"MÃ¼ÅŸteriyi suÃ§lamak", ok:false},
          {k:"D", t:"Konuyu uzatmak", ok:false}
        ]},
        { id:"q7", q:"AÃ§Ä±k rÄ±za ne demektir?", options:[
          {k:"A", t:"BilgilendirilmiÅŸ ÅŸekilde onay vermek", ok:true},
          {k:"B", t:"Zorla onay", ok:false},
          {k:"C", t:"Sessiz kalmak", ok:false},
          {k:"D", t:"OnaysÄ±z iÅŸlem", ok:false}
        ]},
        { id:"q8", q:"Ä°YS/KVKK anlatÄ±mÄ±nda doÄŸru yaklaÅŸÄ±m?", options:[
          {k:"A", t:"Åeffaf ve net aÃ§Ä±klama", ok:true},
          {k:"B", t:"Gizlemek", ok:false},
          {k:"C", t:"KÃ¼Ã§Ã¼msemek", ok:false},
          {k:"D", t:"Korkutmak", ok:false}
        ]},
        { id:"q9", q:"MÃ¼ÅŸteri izinleri sonradan deÄŸiÅŸtirebilir mi?", options:[
          {k:"A", t:"Evet, ret/iptal hakkÄ± vardÄ±r", ok:true},
          {k:"B", t:"HayÄ±r, sonsuza kadar kalÄ±r", ok:false},
          {k:"C", t:"Sadece bankadan", ok:false},
          {k:"D", t:"Sadece yazÄ±yla", ok:false}
        ]},
        { id:"q10", q:"ProsedÃ¼rde kritik adÄ±m nedir?", options:[
          {k:"A", t:"OnayÄ± teyit etmek", ok:true},
          {k:"B", t:"OnaysÄ±z ilerlemek", ok:false},
          {k:"C", t:"Konuyu kapatmak", ok:false},
          {k:"D", t:"YanlÄ±ÅŸ bilgi vermek", ok:false}
        ]}
      ]
    }
  };

  function getScenario(){
    return SCENARIOS[callTypeEl.value] || SCENARIOS.sktt_sales;
  }

  function renderScenarioUI(){
    const sc = getScenario();
    scenarioChip.textContent = "Senaryo: " + sc.title;

    // Flow hint
    flowHint.innerHTML = `Hedef akÄ±ÅŸ: <b>${sc.stageLabels[0]}</b> â†’ <b>${sc.stageLabels[1]}</b> â†’ <b>${sc.stageLabels[2]}</b> â†’ <b>${sc.stageLabels[3]}</b> â†’ <b>${sc.stageLabels[4]}</b>`;

    // Lock texts
    lockTextEmp.textContent = sc.gates.empathy.required
      ? "Empati algÄ±lanmadan sÃ¼reÃ§ ilerlemez."
      : "Empati Ã¶nerilir.";

    lockTextDocs.textContent = sc.gates.docsConfirm.required
      ? "Bu senaryoda onaya geÃ§meden Ã¶nce yazÄ±lÄ± bilgilendirme/onay teyidi gerekir."
      : "Bu senaryoda yazÄ±lÄ± teyit zorunlu deÄŸil.";

    // Quick buttons
    quickRow.innerHTML = "";
    sc.quick.forEach(q => {
      const b = document.createElement("button");
      b.type = "button";
      b.dataset.quick = q.key;
      b.textContent = q.label;
      b.addEventListener("click", () => {
        if (talkBtn.disabled) return;
        addBubble("agent", q.text);
        const reply = customerReply(q.text);
        setTimeout(() => { addBubble("cust", reply); speakTR(reply); }, 200);
      });
      quickRow.appendChild(b);
    });
  }

  callTypeEl.addEventListener("change", () => {
    renderScenarioUI();
    resetAll(); // senaryo deÄŸiÅŸince temiz baÅŸlasÄ±n
  });

  // --- Stage & Gates
  let stage = 0;           // 0..4
  let mistakes = 0;
  let lastReply = "";

  let gateEmpathy = false;
  let gateDocsConfirm = false;

  function setStage(n){
    stage = n;
    const shown = Math.min(4, stage);
    stageChip.textContent = `AÅŸama: ${shown}/4`;
  }

  function setGateVisual(dotEl, ok){
    if (ok) dotEl.classList.add("ok");
    else dotEl.classList.remove("ok");
  }

  function avoidRepeat(text){
    if (text === lastReply) text = text + " (LÃ¼tfen net ilerleyelim.)";
    lastReply = text;
    return text;
  }

  function evaluateGates(agentText){
    const sc = getScenario();
    const t = (agentText || "").toLowerCase();

    if (sc.gates.empathy.cues.test(t)) gateEmpathy = true;
    if (sc.gates.docsConfirm.cues.test(t)) gateDocsConfirm = true;

    setGateVisual(lockDotEmp, gateEmpathy || !sc.gates.empathy.required);
    setGateVisual(lockDotDocs, gateDocsConfirm || !sc.gates.docsConfirm.required);
  }

  function scoreFromCues(agentText){
    const sc = getScenario();
    const t = (agentText || "").toLowerCase();

    if (sc.gates.empathy.cues.test(t)) bump("emp", 25);
    if (sc.cues.info.test(t)) bump("info", 25);
    if (sc.cues.sol.test(t)) bump("sol", 25);
    if (sc.cues.pro.test(t)) bump("pro", 25);
  }

  function applyWrongChecks(agentText){
    const sc = getScenario();
    const t = (agentText || "").toLowerCase();

    for (const w of sc.wrong){
      if (w.re.test(t)){
        mistakes++;
        coachEl.textContent = w.msg;
        return true;
      }
    }
    return false;
  }

  function customerReply(agentText){
    const sc = getScenario();
    const t = (agentText || "").toLowerCase().trim();

    const tooShort = t.length < 10;
    const irrelevant = /(baÅŸka sorunuz var mÄ±|baÅŸka bir ÅŸey|tamamdÄ±r|peki|hmm|dinledim|anladÄ±m)/i.test(t);

    // Evaluate & Score
    evaluateGates(agentText);
    scoreFromCues(agentText);

    // Wrong info handling
    if (applyWrongChecks(agentText)){
      return avoidRepeat(buildReply([
        "Bu sÃ¶ylediÄŸiniz bana doÄŸru gelmedi.",
        "LÃ¼tfen konuyu doÄŸru Ã§erÃ§evede anlatÄ±n.",
        "Net bir aÃ§Ä±klama istiyorum."
      ]));
    }

    // Too short / irrelevant
    if (tooShort || irrelevant){
      mistakes++;
      coachEl.textContent = "KoÃ§: KÄ±sa/alakasÄ±z cevap. Empati + net Ã§erÃ§eve + bir sonraki adÄ±mÄ± sÃ¶yle.";
      return avoidRepeat(buildReply([
        "Bu cevap yeterli deÄŸil.",
        "LÃ¼tfen net anlatÄ±n ve Ã§Ã¶zÃ¼m Ã¶nerin.",
        "AdÄ±m adÄ±m gidelim."
      ]));
    }

    // Stage engine (always 0..4; senaryonun bazÄ± kilitleri zorunlu olmayabilir)
    // Stage 0: Empati
    if (stage === 0){
      if (sc.gates.empathy.required && !gateEmpathy){
        mistakes++;
        coachEl.textContent = sc.coachByStage[0];
        return avoidRepeat(buildReply([
          "Beni anladÄ±ÄŸÄ±nÄ±zÄ± hissetmiyorum.",
          "Ã–nce empati kurar mÄ±sÄ±nÄ±z?",
          "Sonra konuya geÃ§elim."
        ]));
      }
      setStage(1); mistakes = 0;
      coachEl.textContent = sc.coachByStage[1];
      return avoidRepeat(buildReply([
        "Tamam, teÅŸekkÃ¼r ederim.",
        `Åimdi ${sc.stageLabels[1]} kÄ±smÄ±nÄ± net anlatÄ±r mÄ±sÄ±nÄ±z?`,
        "Detay rica ediyorum."
      ]));
    }

    // Stage 1: Bilgi/Ã‡erÃ§eve
    if (stage === 1){
      if (!sc.cues.info.test(t)){
        mistakes++;
        coachEl.textContent = "KoÃ§: Bilgi/Ã§erÃ§eve eksik. TanÄ±mÄ± ve â€˜nedenâ€™ kÄ±smÄ±nÄ± sÃ¶yle.";
        return avoidRepeat(buildReply([
          "HÃ¢lÃ¢ net deÄŸil.",
          "LÃ¼tfen tanÄ±mÄ±nÄ± ve nedenini anlatÄ±n."
        ]));
      }
      setStage(2); mistakes = 0;
      coachEl.textContent = sc.coachByStage[2];
      return avoidRepeat(buildReply([
        "Peki Ã§Ã¶zÃ¼m ne?",
        `Åimdi ${sc.stageLabels[2]} kÄ±smÄ±na geÃ§ebilir miyiz?`,
        "Ne Ã¶neriyorsunuz?"
      ]));
    }

    // Stage 2: Ã‡Ã¶zÃ¼m/Teklif
    if (stage === 2){
      if (!sc.cues.sol.test(t)){
        mistakes++;
        coachEl.textContent = "KoÃ§: Ã‡Ã¶zÃ¼m/teklif eksik. MÃ¼ÅŸteriye net bir yol sun.";
        return avoidRepeat(buildReply([
          "Net bir Ã§Ã¶zÃ¼m duymadÄ±m.",
          "Bana seÃ§enek sunar mÄ±sÄ±nÄ±z?"
        ]));
      }
      setStage(3); mistakes = 0;
      coachEl.textContent = sc.coachByStage[3];
      return avoidRepeat(buildReply([
        "ÅartlarÄ± yazÄ±lÄ± gÃ¶rmek istiyorum.",
        "SMS/mail ile iletir misiniz?",
        "Sonra nasÄ±l onaylayacaÄŸÄ±m?"
      ]));
    }

    // Stage 3: ProsedÃ¼r + (senaryoya gÃ¶re) docsConfirm gate
    if (stage === 3){
      // ProsedÃ¼r cues yoksa geri dÃ¶ndÃ¼r
      if (!sc.cues.pro.test(t)){
        mistakes++;
        coachEl.textContent = "KoÃ§: ProsedÃ¼r eksik. YazÄ±lÄ± bilgilendirme/teyit/onay adÄ±mlarÄ±nÄ± sÃ¶yle.";
        return avoidRepeat(buildReply([
          "ProsedÃ¼rÃ¼ net duymadÄ±m.",
          "YazÄ±lÄ± bilgilendirme ve onay adÄ±mÄ± nasÄ±l olacak?"
        ]));
      }

      // Docs confirm required?
      if (sc.gates.docsConfirm.required && !gateDocsConfirm){
        mistakes++;
        coachEl.textContent = "KoÃ§: Bu senaryoda â€˜bilgilendirme ulaÅŸtÄ± mÄ± / teyit eder misiniz?â€™ kilidi aÃ§Ä±lmadan onaya geÃ§me.";
        return avoidRepeat(buildReply([
          "SMS/mail gelmeden onay veremem.",
          "LÃ¼tfen Ã¶nce yazÄ±lÄ± bilgilendirmeyi gÃ¶nderin ve teyidimi alÄ±n."
        ]));
      }

      setStage(4); mistakes = 0;
      coachEl.textContent = sc.coachByStage[4];
      return avoidRepeat(buildReply([
        "Tamam, ilerleyebiliriz.",
        "Onay adÄ±mÄ± nedir?",
        "Ä°ÅŸlemi tamamlayalÄ±m."
      ]));
    }

    // Stage 4: KapanÄ±ÅŸ
    coachEl.textContent = sc.coachByStage[4];
    return avoidRepeat(buildReply([
      "TeÅŸekkÃ¼rler.",
      "BaÅŸka bir ÅŸey yoksa kapatalÄ±m."
    ]));
  }

  // --- Speech Recognition
  let recognition = null;
  let listening = false;

  function setupRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR){
      alert("Bu tarayÄ±cÄ± STT desteklemiyor. Chrome/Edge deneyin.");
      return null;
    }
    const r = new SR();
    r.lang = "tr-TR";
    r.interimResults = false;
    r.continuous = false;

    r.onstart = () => { listening=true; statusEl.textContent="Durum: dinleniyorâ€¦"; };
    r.onend   = () => { listening=false; statusEl.textContent="Durum: beklemede"; };
    r.onerror = (e) => { statusEl.textContent="Hata: " + (e?.error || "bilinmiyor"); };

    r.onresult = (e) => {
      const text = e.results?.[0]?.[0]?.transcript || "";
      if (!text) return;
      addBubble("agent", text);
      const reply = customerReply(text);
      setTimeout(() => { addBubble("cust", reply); speakTR(reply); }, 220);
    };
    return r;
  }

  // --- Quiz helpers
  function pickRandomQuestions(pool, n=3){
    const a = [...pool];
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a.slice(0,n);
  }
  let currentQuiz = [];
  let lastQuizScore = 0;

  function openQuiz(){
    const sc = getScenario();
    currentQuiz = pickRandomQuestions(sc.quizPool, 3);

    quizArea.innerHTML = "";
    finalArea.style.display = "none";

    currentQuiz.forEach((qq, idx) => {
      const div = document.createElement("div");
      div.className = "q";
      div.innerHTML = `<h4>${idx+1}) ${qq.q}</h4>`;
      qq.options.forEach(opt => {
        const line = document.createElement("label");
        line.className = "opt";
        line.innerHTML = `<input type="radio" name="${qq.id}" value="${opt.k}" /> <span><b>${opt.k})</b> ${opt.t}</span>`;
        div.appendChild(line);
      });
      quizArea.appendChild(div);
    });

    quizBackdrop.style.display = "flex";
  }

  function closeQuizModal(){ quizBackdrop.style.display = "none"; }
  closeQuiz.onclick = closeQuizModal;
  quizBackdrop.addEventListener("click", (e) => { if (e.target === quizBackdrop) closeQuizModal(); });

  gradeQuiz.onclick = () => {
    let correct = 0;
    const total = currentQuiz.length;

    currentQuiz.forEach(qq => {
      const picked = document.querySelector(`input[name="${qq.id}"]:checked`)?.value || "";
      const ok = qq.options.find(o => o.ok)?.k;
      if (picked && picked === ok) correct++;
    });

    const quizScore = Math.round((correct / total) * 100);
    lastQuizScore = quizScore;

    const callScore = Math.round((score.emp + score.info + score.sol + score.pro) / 4);
    const totalScore = Math.round(callScore * 0.7 + quizScore * 0.3);

    const name = (agentNameEl.value || "").trim() || "â€”";
    const toneMap = {calm:"Sakin", talkative:"KonuÅŸkan", angry:"Ã–fkeli", bargainer:"PazarlÄ±kÃ§Ä±"};
    const sc = getScenario();

    finalSummary.textContent = `Ã‡aÄŸrÄ±: ${callScore}/100 Â· Quiz: ${quizScore}/100 Â· Toplam: ${totalScore}/100`;

    const report =
`ROLE PLAY RAPORU
Asistan: ${name}
Senaryo: ${sc.title}
MÃ¼ÅŸteri Profili: ${toneMap[personaTone()]} (konuÅŸkanlÄ±k ${talkEl.value}/10)

Kilitler
- Empati: ${gateEmpathy || !sc.gates.empathy.required ? "TAMAM" : "EKSÄ°K"}
- YazÄ±lÄ± teyit/Onay: ${gateDocsConfirm || !sc.gates.docsConfirm.required ? "TAMAM" : "EKSÄ°K"}

KPI
- Empati: ${score.emp}
- Bilgi/Ã‡erÃ§eve: ${score.info}
- Ã‡Ã¶zÃ¼m/Teklif: ${score.sol}
- ProsedÃ¼r: ${score.pro}

Skorlar
- Ã‡aÄŸrÄ±: ${callScore}/100
- Quiz: ${quizScore}/100 (${correct}/${total})
- TOPLAM: ${totalScore}/100`;

    reportText.textContent = report;
    finalArea.style.display = "block";
  };

  copyReport.onclick = async () => {
    try{
      await navigator.clipboard.writeText(reportText.textContent);
      copyReport.textContent = "âœ… KopyalandÄ±";
      setTimeout(()=>copyReport.textContent="ğŸ“‹ Sonucu Kopyala", 1200);
    }catch{
      alert("Kopyalama baÅŸarÄ±sÄ±z. TarayÄ±cÄ± izinlerini kontrol edin.");
    }
  };

  // --- Reset & Start
  function resetAll(){
    chat.innerHTML = "";
    score = { emp:0, info:0, sol:0, pro:0 };
    renderScore();

    setStage(0);
    mistakes = 0;
    lastReply = "";

    gateEmpathy = false;
    gateDocsConfirm = false;

    const sc = getScenario();
    setGateVisual(lockDotEmp, !sc.gates.empathy.required);
    setGateVisual(lockDotDocs, !sc.gates.docsConfirm.required);

    coachEl.textContent = "BaÅŸlatâ€™a basÄ±nca mÃ¼ÅŸteri konuÅŸacak. Empati ile baÅŸla.";
    statusEl.textContent = "Durum: beklemede";
    talkBtn.disabled = true;
    stopBtn.disabled = true;

    try{ window.speechSynthesis.cancel(); }catch{}
    if (recognition && listening) recognition.stop();
  }

  resetBtn.onclick = resetAll;
  endBtn.onclick = openQuiz;

  startBtn.onclick = () => {
    if (!recognition) recognition = setupRecognition();
    if (!recognition) return;

    resetAll();

    const sc = getScenario();
    const opening = rand(sc.opens[personaTone()] || sc.opens.talkative);
    addBubble("cust", opening);
    speakTR(opening);

    coachEl.textContent = sc.coachByStage[0];
    statusEl.textContent = "Durum: hazÄ±r";
    talkBtn.disabled = false;
    stopBtn.disabled = false;
  };

  talkBtn.onclick = () => {
    if (!recognition) return;
    if (!listening) recognition.start();
  };

  stopBtn.onclick = () => {
    try{ window.speechSynthesis.cancel(); }catch{}
    if (recognition && listening) recognition.stop();
  };

  // Init
  renderScenarioUI();
  renderScore();
  setStage(0);
  resetAll();
});
</script>

</body>
</html>
